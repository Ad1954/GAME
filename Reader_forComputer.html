<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡ä»¶æœ—è®€åŠ©æ‰‹ (æ”¯æ´æ‰‹å‹•è²¼å…¥)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: rgba(255, 255, 255, 0.95);
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        /* ç§»é™¤å…¨é æ²å‹•ï¼Œæ”¹ç‚ºæ»¿ç‰ˆä½ˆå±€ */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: var(--bg);
            font-family: system-ui, -apple-system, sans-serif;
            color: var(--text-main);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .grid {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0; 
        }

        /* å´é‚Šæ¬„å›ºå®šå¯¬åº¦ä¸”ä¸æ²å‹• */
        .sidebar {
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* ä¸»å…§å®¹å€ç¨ç«‹æ²å‹• */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .content-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* æ–‡å­—å®¹å™¨ï¼šæ”¯æ´æ‰‹å‹•ç·¨è¼¯èˆ‡è²¼å…¥ */
        #textContainer {
            flex: 1;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            line-height: 2;
            font-size: 1.15rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            outline: none;
            transition: border-color 0.2s;
        }

        #textContainer:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .sentence {
            cursor: pointer;
            transition: background 0.15s;
            border-radius: 3px;
        }
        .sentence:hover {
            background-color: #f1f5f9;
        }

        .reading-highlight {
            background-color: #fde047 !important;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(253, 224, 71, 0.5);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 12px 5px 0 5px;
            font-size: 0.9rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .progress-tag {
            background: #eff6ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
        }

        #fileInput { display: none; }
        .file-label {
            display: block;
            border: 2px dashed var(--border);
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .file-label:hover { background: #f1f5f9; }

        input[type="range"] { width: 100%; margin: 10px 0; cursor: pointer; }

        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #e2e8f0; color: var(--text-main); }
        .btn-stop { background: #fee2e2; color: #b91c1c; }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            padding: 8px;
            border-bottom: 1px solid var(--border);
            background: #fff;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        /* è²¼ä¸Šæç¤º */
        .placeholder-hint {
            color: #94a3b8;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .grid { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; flex-shrink: 0; overflow-y: visible; }
            #textContainer { min-height: 300px; }
            html, body { overflow: auto; height: auto; }
            .app-container { height: auto; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1 style="margin: 0; font-size: 1.5rem;">æ–‡ä»¶æœ—è®€åŠ©æ‰‹ <small style="font-size: 0.5em; background: #2563eb; color: #fff; padding: 2px 6px; border-radius: 4px; vertical-align: middle;">V4.1 æ”¯æ´è²¼å…¥</small></h1>
        </header>

        <div class="grid">
            <!-- å´é‚Šæ§åˆ¶æ¬„ -->
            <div class="sidebar">
                <div class="glass-card">
                    <label style="font-weight: bold; font-size: 0.9rem;">1. åŒ¯å…¥æˆ–è²¼å…¥æ–‡å­—</label>
                    <label for="fileInput" class="file-label">ğŸ“ é¸æ“‡æª”æ¡ˆ (.txt)</label>
                    <input type="file" id="fileInput" accept=".txt">
                    <button class="btn-secondary" style="font-size: 0.8rem; padding: 8px;" onclick="clearContent()">ğŸ—‘ æ¸…ç©ºå€å¡Š</button>
                </div>

                <div class="glass-card">
                    <label style="font-weight: bold; font-size: 0.9rem;">2. èªéŸ³èˆ‡èªé€Ÿ</label>
                    <select id="voiceSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--border);"></select>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                        <span>èªé€Ÿè¨­å®š</span>
                        <span id="rateValue" style="color: var(--primary); font-weight: bold;">1.0x</span>
                    </div>
                    <input type="range" id="rateInput" min="0.5" max="4" step="0.1" value="1.0">
                </div>

                <div class="glass-card">
                    <button class="btn-primary" id="playBtn">â–¶ é–‹å§‹æœ—è®€</button>
                    <button class="btn-secondary" id="pauseBtn">â¸ æš«åœ / ç¹¼çºŒ</button>
                    <button class="btn-stop" id="stopBtn">â¹ åœæ­¢</button>

                    <div style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
                        <div style="font-weight: bold; font-size: 0.8rem; margin-bottom: 10px;">æœ€è¿‘é–±è®€ç´€éŒ„</div>
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å…§å®¹å€ -->
            <div class="main-content">
                <div class="glass-card content-card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; flex-shrink: 0;">
                        <span id="currentFileName" style="font-weight: bold; color: var(--primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%;">ç·¨è¼¯ä¸­å…§å®¹</span>
                        <div id="statusIndicator" style="font-size: 0.8rem; background: #f1f5f9; padding: 2px 10px; border-radius: 20px;">å¾…æ©Ÿ</div>
                    </div>
                    
                    <!-- å¯ç·¨è¼¯çš„æ–‡å­—å®¹å™¨ -->
                    <div id="textContainer" contenteditable="true" spellcheck="false">åœ¨æ­¤è™•é»æ“Šä¸¦è²¼å…¥æ‚¨çš„æ–‡å­—...</div>
                    
                    <div class="status-bar">
                        <span id="charCount">å­—æ•¸ï¼š0</span>
                        <span id="progressInfo" class="progress-tag">é€²åº¦ï¼š0 / 0 å¥</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const synth = window.speechSynthesis;
        const textContainer = document.getElementById('textContainer');
        const fileInput = document.getElementById('fileInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateInput = document.getElementById('rateInput');
        const rateValue = document.getElementById('rateValue');
        const playBtn = document.getElementById('playBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const progressInfo = document.getElementById('progressInfo');
        const charCount = document.getElementById('charCount');
        const historyList = document.getElementById('historyList');

        let allSentences = []; 
        let currentIdx = 0;
        let fileName = "æ‰‹å‹•è¼¸å…¥";
        let isPaused = false;
        const STORAGE_KEY = 'reader_full_v4_paste';

        // --- æ–‡å­—è§£ææ ¸å¿ƒ ---
        function parseText(text) {
            charCount.textContent = `å­—æ•¸ï¼š${text.length.toLocaleString()}`;
            
            // åˆ†å‰²æ¨™é»ç¬¦è™Ÿä¸¦ä¿ç•™
            allSentences = text.split(/([ï¼Œã€‚ï¼ï¼Ÿï¼›\n])/).reduce((acc, cur, idx) => {
                if (idx % 2 === 0) {
                    if (cur.trim()) acc.push(cur);
                } else {
                    if (acc.length > 0) acc[acc.length - 1] += cur;
                }
                return acc;
            }, []).filter(s => s.trim().length > 0);

            updateProgress();
        }

        // --- è™•ç†æ‰‹å‹•è²¼å…¥èˆ‡ç·¨è¼¯ ---
        textContainer.addEventListener('paste', (e) => {
            // ç¨ç­‰ä¸€æœƒå¾…è²¼å…¥å®Œæˆå†è§£æ
            setTimeout(() => {
                const plainText = textContainer.innerText;
                parseText(plainText);
                renderAsSentences(); // è²¼å…¥å¾Œç«‹å³è½‰ç‚ºå¥å­æ¨¡å¼ä»¥åˆ©é»é¸
            }, 10);
        });

        textContainer.addEventListener('focus', () => {
            if (textContainer.innerText.includes('åœ¨æ­¤è™•é»æ“Šä¸¦è²¼å…¥')) {
                textContainer.innerText = '';
            }
            // ç·¨è¼¯æ™‚ç§»é™¤é«˜äº®
            const prev = textContainer.querySelector('.reading-highlight');
            if (prev) prev.classList.remove('reading-highlight');
        });

        function clearContent() {
            textContainer.innerText = '';
            allSentences = [];
            currentIdx = 0;
            fileName = "æ‰‹å‹•è¼¸å…¥";
            document.getElementById('currentFileName').textContent = "ç·¨è¼¯ä¸­å…§å®¹";
            updateProgress();
            charCount.textContent = `å­—æ•¸ï¼š0`;
            synth.cancel();
        }

        // --- æª”æ¡ˆè¼‰å…¥ ---
        async function loadFile(file) {
            fileName = file.name;
            document.getElementById('currentFileName').textContent = fileName;
            statusIndicator.textContent = "è¼‰å…¥ä¸­...";
            
            const text = await file.text();
            parseText(text);
            renderAsSentences();
            
            currentIdx = 0;
            checkHistory();
            statusIndicator.textContent = "è¼‰å…¥å®Œæˆ";
        }

        // å°‡ç´”æ–‡å­—è½‰ç‚ºå¯é»é¸çš„ <span> å¥å­
        function renderAsSentences() {
            const rawText = textContainer.innerText;
            if (allSentences.length === 0) return;

            textContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            allSentences.forEach((text, i) => {
                const span = document.createElement('span');
                span.textContent = text;
                span.className = 'sentence';
                span.dataset.index = i;
                span.onclick = (e) => {
                    e.stopPropagation();
                    jumpTo(i);
                };
                fragment.appendChild(span);
            });
            textContainer.appendChild(fragment);
            textContainer.contentEditable = "true"; // ä»ä¿æŒå¯ç·¨è¼¯
        }

        function jumpTo(i) {
            currentIdx = i;
            synth.cancel();
            updateHighlight();
            updateProgress();
            if (!isPaused) startReading();
        }

        function updateHighlight() {
            const prev = textContainer.querySelector('.reading-highlight');
            if (prev) prev.classList.remove('reading-highlight');
            
            const current = textContainer.querySelector(`span[data-index="${currentIdx}"]`);
            if (current) {
                current.classList.add('reading-highlight');
                current.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateProgress() {
            progressInfo.textContent = `ç¬¬ ${currentIdx + 1} / ${allSentences.length} å¥`;
        }

        // --- æœ—è®€æ§åˆ¶ ---
        function startReading() {
            // å¦‚æœå®¹å™¨é‚„æ˜¯ç´”æ–‡å­—ï¼ˆæ²’è¢« renderAsSentences è½‰æ›ï¼‰ï¼Œå‰‡å…ˆè½‰æ›ä¸€æ¬¡
            if (textContainer.children.length === 0 && allSentences.length > 0) {
                renderAsSentences();
            }

            if (currentIdx >= allSentences.length) {
                statusIndicator.textContent = "æ’­æ”¾çµæŸ";
                return;
            }

            const utterance = new SpeechSynthesisUtterance(allSentences[currentIdx]);
            utterance.voice = voices[voiceSelect.value];
            utterance.rate = parseFloat(rateInput.value);

            utterance.onstart = () => {
                statusIndicator.textContent = "æœ—è®€ä¸­";
                updateHighlight();
                updateProgress();
                saveHistory();
            };

            utterance.onend = () => {
                if (!isPaused) {
                    currentIdx++;
                    startReading();
                }
            };

            utterance.onerror = () => {
                currentIdx++;
                startReading();
            };

            synth.speak(utterance);
        }

        rateInput.oninput = () => {
            rateValue.textContent = rateInput.value + 'x';
            if (synth.speaking && !isPaused) {
                synth.cancel();
                startReading();
            }
        };

        let voices = [];
        function initVoices() {
            voices = synth.getVoices();
            if (voices.length === 0) return;
            voiceSelect.innerHTML = voices.map((v, i) => `<option value="${i}">${v.name} (${v.lang})</option>`).join('');
            const twIdx = voices.findIndex(v => v.lang.includes('zh-TW'));
            if (twIdx !== -1) voiceSelect.value = twIdx;
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = initVoices;
        initVoices();

        function saveHistory() {
            if (fileName === "æ‰‹å‹•è¼¸å…¥") return; // æ‰‹å‹•è¼¸å…¥ä¸å„²å­˜é€²åº¦ä»¥é˜²æ··äº‚
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            history[fileName] = { idx: currentIdx, time: Date.now() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistoryUI();
        }

        function renderHistoryUI() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const keys = Object.keys(history).sort((a,b) => history[b].time - history[a].time);
            historyList.innerHTML = keys.slice(0, 5).map(name => `
                <div class="history-item">
                    <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${name}">${name}</span>
                    <button onclick="recall('${name.replace(/'/g,"\\'")}')" style="width:auto; margin:0; padding:4px 8px; font-size:0.7rem; background:#f1f5f9;">è¼‰å…¥æª”æ¡ˆ</button>
                </div>
            `).join('');
        }

        window.recall = (name) => {
            alert(`è«‹å…ˆé»æ“Šã€Œé¸æ“‡æª”æ¡ˆã€é‡æ–°è¼‰å…¥ï¼š\nã€${name}ã€‘\nè¼‰å…¥å¾Œå°‡è‡ªå‹•è·³è½‰é€²åº¦ã€‚`);
        };

        function checkHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            if (history[fileName]) {
                const h = history[fileName];
                if (confirm(`åµæ¸¬åˆ°ã€Œ${fileName}ã€ä¸Šæ¬¡é€²åº¦ï¼šç¬¬ ${h.idx + 1} å¥ï¼Œæ˜¯å¦è·³è½‰ï¼Ÿ`)) {
                    jumpTo(h.idx);
                }
            }
        }

        fileInput.onchange = e => { if (e.target.files[0]) loadFile(e.target.files[0]); };
        
        playBtn.onclick = () => { 
            isPaused = false; 
            synth.cancel(); 
            // å¦‚æœæ˜¯ç·¨è¼¯ä¸­çš„ç´”æ–‡å­—ï¼Œé»é–‹å§‹æ™‚è§£æä¸¦è½‰æ›
            if (textContainer.innerText && allSentences.length === 0) {
                parseText(textContainer.innerText);
            }
            startReading(); 
        };

        pauseBtn.onclick = () => {
            if (synth.speaking && !isPaused) {
                isPaused = true; synth.cancel();
                statusIndicator.textContent = "å·²æš«åœ";
            } else {
                isPaused = false; startReading();
            }
        };

        document.getElementById('stopBtn').onclick = () => {
            isPaused = true; synth.cancel();
            currentIdx = 0;
            updateHighlight();
            updateProgress();
            statusIndicator.textContent = "åœæ­¢";
        };

        renderHistoryUI();
    </script>
</body>
</html>